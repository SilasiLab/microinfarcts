# Microinfarcts
* Microinfarcts is a project for loacting the real location of beads inside the brain and use ANTs to align the brain into Allen atlas. 
* First human labeled position of micro infarcts inside the brain images will be clustered and organized, after some calculation they will be transformed into a list of masks containing the real location of the micro infarcts. After that the transform matrix achieved in aligning the brain into atlas will be applied on the masks. Then the masks as well as the Allen annotaion files will be involved in coming processes and registered into the standard Allen atlas. Finally you will have two optional ways to view your result.
* 1. A csv file indicating the number of micro infarcts located in different brain regions.
* 2. A opencv window showing the standard atlas, symmerically normalized brain images and the location of the micro infarcts. 
* ![opencv window](https://github.com/SilasiLab/microinfarcts/blob/master/pics/show.png)
* You will be able to ajust the transparency using the buttons `q(-)` and `e(+)`, and also position the image using the buttons `a (previous imgae)` and `d (next image)`.
* The reference atlas comes from Allen Atlas organization. You can find reference data on google drive link attached here:(https://drive.google.com/drive/folders/10MqL8BXkfRsjLgWRuoxJUuZzH9AuWIOe?usp=sharing)
* After downloading the reference file, you need to copy it into `atlas_reference` folder.
* So the whole structure of the project should be:
    * `microinfarcts/src`
    * `microinfarcts/atlas_reference`
    * `microinfarcts/atlas_reference/annotation.mhd`
    * `microinfarcts/atlas_reference/annotation.raw`
    * `microinfarcts/atlas_reference/atlasVolume.mhd`
    * `microinfarcts/atlas_reference/atlasVolume.raw`

## 1. Install dependencies
 * 1. `conda install pandas`
 * 2. `conda install -c conda-forge ffmpeg`
 * 3. `conda install -c conda-forge opencv`
 * 4. `conda install matplotlib`
 * 5. `conda install pickle`
 * 6. `conda install tqdm`
 * 7. `conda install scikit-image`
 * 8. `pip install nipype`
 * 9. `conda install pyqt5`
 * 10. `conda install tk`
 * 11. Download and compile ANTs from (https://brianavants.wordpress.com/2012/04/13/updated-ants-compile-instructions-april-12-2012/)
 * 12. `git clone https://github.com/SilasiLab/microinfarcts.git`

## 2. Preparatory phase
  * 1. For the input raw data, the input folder directory structure should be: `[Your folder containing all the brains]/[brain id](individual brain)/raw/[images_b.jpg]`. Images should all have a postfix `b` (`imageid_b`, e.g.) which indicates color channel blue.
  * 2. You will need a folder to save the result as also. Feel free to create your own folders.
  * After downloading as well as compiling ANTs, you should find the dirctory of `antsRegistrationSyNQuick.sh` under ANTs `Scripts` folder. Take this PC as an example, it is `/home/silasi/ANTs/Scripts/antsRegistrationSyNQuick.sh`. Then the folder containing `antsRegistrationSyNQuick.sh`, that is `/home/silasi/ANTs/Scripts/` which will be used as the parameter `--ant` of the whole project. Here we leave it as [Script folder] for short and for future use.
  
## 3. Simple GUI
  * 1. `cd [your directory]/microinfarcts/src`
  * 2. `python main.py`
  * 3. 
       ![Gui](/pics/microinfarctsGUI.png)
  * 4. Check `Auto Segmentation` will perform a Discrete Fourier Transform to find the microinfarcts(bright circle area) in brain scans.
  * 5. Check `Use existing  manual label`, the script will require a human label csv summary generated by the imageJ script [ImageJ Script](https://github.com/SilasiLab/microinfarcts/blob/master/imageJ/Bead%20Finder%20v0.1.4.ijm).
  * 6. Check `Show the result`, the script will transform the bead location mask and project it on the brain scan. If you select this option, then no summary files will be generated.
  * 7. Check `Write a summary`, a summary csv, a structual tree txt, a structual tree image will be generated under `[result folder]/[brain id]/`.
## 3. User guide
  * 1. Simple guide.
      * Write a summary and generate a tree graph in both image and txt format as well:
        * 1. [Input directory]: The folder holds individual brains folders.
        * 2. [Output directory]: A empty folder you would like to save the result.
        * 3. `cd microinfarcts/src`
        * 4. `python main.py --r [Input directory] --s [Output directory] --ant [Script folder]`
        * 5. Microinfarcts script will run through brains. It will take a while to finish the whole process. After running, there will be a csv file named as `summary.csv` under the `[output directory]/[brain id]`.
      * Show in image:
        * 1. First three steps are the same as `write a summary`.
        * 2. If you have already gone through the previous step then the command should be `python main.py --r [Input directory] --s [Output directory] --ant [Script folder] --p False --re False --a True --w False --sh True` 
        * 3. Then it will show up a window presenting the result.
  * 2. Detailed guide.
      * `--r`: Root directory or input directory, indicates the root directory mentioned in `2.Preparatory phase`, which holds individual brains.
      * `--s`: Save directory or output directory, an empty folder to save your middle results and final results.
      * `--ant`: The directory to script folder under ANTs directory.
      * `--p`: Read the atlas file and annotation file and transfer them into .pickle data. Default is `True`, if you have already finshed one whole process before or have those pickle file saved under `atlas_reference` folder, then you may set this parameter as `False` to skip it and save time.
      * `--re`: Use ANTs as backend to align the brain into standard Allen atlas. Default is `True`, Similar to the previous parameter, if you already have the middle result saved in `[Output directory]/output` folder, then you may set it as `False `to skip it and save time.
      * `--a`: Apply the trasform matrix calculated in ANTs registration on mask of micro infarcts as well as the tissue image. Default is `True`. Please always set it as `True` to avoide hindering the next process.
      * `--w`: Write the registraion result into a csv file. This function is not compatible with `show` function. So the parameter `--w` cannot be set as `True` while `--sh` is already set to `True`. 
      * `--sh`: Show the alignment and registration result in a opencv window. This function is not compatible with `write_summary` function. So the parameter `--sh` cannot be set as `True` while `--w` is already set to `True`. 
      * `--shatlas`: Show Allen atlas or annotation as reference background.
      * `--intro`: Show introduction on opencv frame or not, Default is True.
